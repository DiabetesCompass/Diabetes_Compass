//
//  BGAlgorithmTests.m
//  CompassRose
//
//  Created by Christopher Balcells on 11/11/13.
//  Copyright (c) 2014 Clif Alferness. All rights reserved.
//

#import <XCTest/XCTest.h>
#import "GraphViewController.h"
#import "CurveModel.h"
#import "FoodReading.h"
#import "Constants.h"


@interface BGAlgorithmTests : XCTestCase
@property (strong, nonatomic) GraphViewController* vc;
@end

@implementation BGAlgorithmTests

- (void)setUp
{
    [super setUp];
    // Put setup code here; it will be run once, before the first test case.
    
    self.vc = [GraphViewController new];
    [MagicalRecord setDefaultModelFromClass:[self class]];
    [MagicalRecord setupCoreDataStackWithInMemoryStore];
}

- (void)tearDown
{
    // Put teardown code here; it will be run once, after the last test case.
    [MagicalRecord cleanUp];
    [super tearDown];
}

- (void)testInsulinEffectForOneUnit
{
    NSEntityDescription *entity = [NSEntityDescription entityForName:@"InsulinReading" inManagedObjectContext:[NSManagedObjectContext MR_defaultContext]];
    InsulinReading* insulin = [[InsulinReading alloc] initWithEntity:entity insertIntoManagedObjectContext:nil];
    insulin.quantity = @(1);
    insulin.timeStamp = [NSDate new];
    
    //This assumes that insulin sensitivity is 1.
    float insulinEffect[[[CurveModel sharedInstance] getInsulinDuration]];
    float expected[400] = {0.000139942432771973, 0.000279884865543947, 0.000419827298315920, 0.000559769731087894, 0.000699712163859867, 0.000839654596631840, 0.000979597029403814, 0.00111953946217579, 0.00125948189494776, 0.00139942432771973, 0.00153936676049171, 0.00167930919326368, 0.00181925162603565, 0.00195919405880763, 0.00209913649157960, 0.00223907892435157, 0.00237902135712355, 0.00251896378989552, 0.00265890622266749, 0.00279884865543947, 0.00293879108821144, 0.00307873352098341, 0.00321867595375539, 0.00335861838652736, 0.00349856081929933, 0.00363850325207131, 0.00377844568484328, 0.00391838811761525, 0.00405833055038723, 0.00419827298315920, 0.00433821541593117, 0.00447815784870315, 0.00461810028147512, 0.00475804271424709, 0.00489798514701907, 0.00503792757979104, 0.00517787001256301, 0.00531781244533499, 0.00545775487810696, 0.00559769731087893, 0.00573763974365091, 0.00587758217642288, 0.00601752460919486, 0.00615746704196683, 0.00629740947473880, 0.00628882209818234, 0.00628023472162588, 0.00627164734506942, 0.00626305996851295, 0.00625447259195649, 0.00624588521540003, 0.00623729783884357, 0.00622871046228711, 0.00622012308573064, 0.00621153570917418, 0.00620294833261772, 0.00619436095606126, 0.00618577357950480, 0.00617718620294833, 0.00616859882639187, 0.00616001144983541, 0.00615142407327895, 0.00614283669672249, 0.00613424932016602, 0.00612566194360956, 0.00611707456705310, 0.00610848719049664, 0.00609989981394018, 0.00609131243738371, 0.00608272506082725, 0.00607413768427079, 0.00606555030771433, 0.00605696293115787, 0.00604837555460140, 0.00603978817804494, 0.00603120080148848, 0.00602261342493202, 0.00601402604837556, 0.00600543867181909, 0.00599685129526263, 0.00598826391870617, 0.00597967654214971, 0.00597108916559325, 0.00596250178903678, 0.00595391441248032, 0.00594532703592386, 0.00593673965936740, 0.00592815228281094, 0.00591956490625447, 0.00591097752969801, 0.00590239015314155, 0.00589380277658509, 0.00588521540002863, 0.00587662802347216, 0.00586804064691570, 0.00596504619690536, 0.00591892880428733, 0.00587281141166929, 0.00582669401905125, 0.00578057662643322, 0.00573445923381518, 0.00568834184119715, 0.00564222444857911, 0.00559610705596107, 0.00554998966334304, 0.00550387227072500, 0.00545775487810696, 0.00541163748548893, 0.00536552009287089, 0.00531940270025285, 0.00527328530763481, 0.00522716791501678, 0.00518105052239874, 0.00513493312978071, 0.00508881573716267, 0.00504269834454463, 0.00499658095192659, 0.00495046355930856, 0.00490434616669052, 0.00485822877407248, 0.00481211138145445, 0.00476599398883641, 0.00471987659621837, 0.00467375920360034, 0.00462764181098230, 0.00458152441836426, 0.00453540702574623, 0.00448928963312819, 0.00444317224051015, 0.00439705484789212, 0.00435093745527408, 0.00430482006265604, 0.00425870267003801, 0.00421258527741997, 0.00416646788480193, 0.00412035049218390, 0.00407423309956586, 0.00402811570694783, 0.00398199831432979, 0.00393588092171175, 0.00388976352909371, 0.00384364613647568, 0.00379752874385764, 0.00375141135123960, 0.00370529395862157, 0.00365917656600353, 0.00361305917338549, 0.00356694178076746, 0.00352082438814942, 0.00347470699553138, 0.00342858960291335, 0.00338247221029531, 0.00333635481767727, 0.00329023742505924, 0.00324412003244120, 0.00319800263982316, 0.00315188524720513, 0.00310576785458709, 0.00305965046196905, 0.00301353306935102, 0.00296741567673298, 0.00292129828411494, 0.00287518089149691, 0.00282906349887887, 0.00278294610626083, 0.00273682871364280, 0.00269071132102476, 0.00264459392840672, 0.00259847653578869, 0.00255235914317065, 0.00250624175055261, 0.00246012435793458, 0.00241400696531654, 0.00236788957269850, 0.00232177218008047, 0.00227565478746243, 0.00222953739484439, 0.00218342000222636, 0.00213730260960832, 0.00209118521699028, 0.00204506782437225, 0.00199895043175421, 0.00195283303913617, 0.00190671564651814, 0.00186059825390010, 0.00185194430853312, 0.00184329036316615, 0.00183463641779917, 0.00182598247243219, 0.00181732852706521, 0.00180867458169824, 0.00180002063633126, 0.00179136669096428, 0.00178271274559731, 0.00177405880023033, 0.00176540485486335, 0.00175675090949637, 0.00174809696412940, 0.00173944301876242, 0.00173078907339544, 0.00172213512802846, 0.00171348118266149, 0.00170482723729451, 0.00169617329192753, 0.00168751934656056, 0.00167886540119358, 0.00167021145582660, 0.00166155751045962, 0.00165290356509265, 0.00164424961972567, 0.00163559567435869, 0.00162694172899172, 0.00161828778362474, 0.00160963383825776, 0.00160097989289078, 0.00159232594752381, 0.00158367200215683, 0.00157501805678985, 0.00156636411142288, 0.00155771016605590, 0.00154905622068892, 0.00154040227532194, 0.00153174832995497, 0.00152309438458799, 0.00151444043922101, 0.00150578649385403, 0.00149713254848706, 0.00148847860312008, 0.00147982465775310, 0.00147117071238613, 0.00146251676701915, 0.00145386282165217, 0.00144520887628519, 0.00143655493091822, 0.00142790098555124, 0.00141924704018426, 0.00141059309481729, 0.00140193914945031, 0.00139328520408333, 0.00138463125871635, 0.00137597731334938, 0.00136732336798240, 0.00135866942261542, 0.00135001547724845, 0.00134136153188147, 0.00133270758651449, 0.00132405364114751, 0.00131539969578054, 0.00130674575041356, 0.00129809180504658, 0.00128943785967960, 0.00128078391431263, 0.00127212996894565, 0.00126347602357867, 0.00125482207821170, 0.00124616813284472, 0.00123751418747774, 0.00122886024211076, 0.00122020629674379, 0.00121155235137681, 0.00120289840600983, 0.00119424446064286, 0.00118559051527588, 0.00117693656990890, 0.00116828262454192, 0.00115962867917495, 0.00115097473380797, 0.00114232078844099, 0.00113366684307401, 0.00112501289770704, 0.00111635895234006, 0.00110770500697308, 0.00109905106160611, 0.00109039711623913, 0.00108174317087215, 0.00107308922550517, 0.00106443528013820, 0.00105578133477122, 0.00104712738940424, 0.00103847344403727, 0.00102981949867029, 0.00102116555330331, 0.00101251160793633, 0.00100385766256936, 0.000995203717202379, 0.000986549771835402, 0.000977895826468425, 0.000969241881101448, 0.000960587935734470, 0.000951933990367493, 0.000943280045000516, 0.000934626099633539, 0.000925972154266562, 0.000917318208899584, 0.000908664263532607, 0.000900010318165630, 0.000891356372798653, 0.000882702427431676, 0.000874048482064698, 0.000865394536697721, 0.000856740591330744, 0.000848086645963767, 0.000839432700596790, 0.000830778755229812, 0.000822124809862835, 0.000813470864495858, 0.000804816919128881, 0.000796162973761903, 0.000787509028394926, 0.000778855083027949, 0.000770201137660972, 0.000761547192293995, 0.000752893246927017, 0.000744239301560040, 0.000735585356193063, 0.000726931410826086, 0.000718277465459109, 0.000709623520092131, 0.000700969574725154, 0.000692315629358177, 0.000683661683991200, 0.000675007738624223, 0.000666353793257245, 0.000657699847890268, 0.000649045902523291, 0.000640391957156314, 0.000631738011789336, 0.000623084066422359, 0.000614430121055382, 0.000605776175688405, 0.000597122230321428, 0.000588468284954450, 0.000579814339587473, 0.000571160394220496, 0.000562506448853519, 0.000553852503486542, 0.000545198558119564, 0.000536544612752587, 0.000527890667385610, 0.000519236722018633, 0.000510582776651656, 0.000501928831284678, 0.000493274885917701, 0.000484620940550724, 0.000475966995183747, 0.000467313049816769, 0.000458659104449792, 0.000450005159082815, 0.000441351213715838, 0.000432697268348861, 0.000424043322981883, 0.000415389377614906, 0.000406735432247929, 0.000398081486880952, 0.000389427541513974, 0.000380773596146997, 0.000372119650780020, 0.000363465705413043, 0.000354811760046066, 0.000346157814679089, 0.000337503869312111, 0.000328849923945134, 0.000320195978578157, 0.000311542033211180, 0.000302888087844202, 0.000294234142477225, 0.000285580197110248, 0.000276926251743271, 0.000268272306376294, 0.000259618361009316, 0.000250964415642339, 0.000242310470275362, 0.000233656524908385, 0.000225002579541407, 0.000216348634174430, 0.000207694688807453, 0.000199040743440476, 0.000190386798073499, 0.000181732852706521, 0.000173078907339544, 0.000164424961972567, 0.000155771016605590, 0.000147117071238613, 0.000138463125871635, 0.000129809180504658, 0.000121155235137681, 0.000112501289770704, 0.000103847344403726, 9.51933990367493e-05, 8.65394536697720e-05, 7.78855083027949e-05, 6.92315629358176e-05, 6.05776175688405e-05, 5.19236722018632e-05, 4.32697268348861e-05, 3.46157814679088e-05, 2.59618361009317e-05, 1.73078907339544e-05, 8.65394536697733e-06, 0};
    [[CurveModel sharedInstance] effectFromInsulinReading:insulin toArray:insulinEffect];
    
    for (int index = 0; index < [[CurveModel sharedInstance] getInsulinDuration]; index++) {
        NSLog(@"The expected: %f, and the actual: %f", expected[index], insulinEffect[index]);
        XCTAssertEqualWithAccuracy(insulinEffect[index], expected[index], 1e-5, @"");
    }
    
}

- (void)testFoodEffectForOneCarb
{
    
}

- (void)testComplete1
{

}

@end
